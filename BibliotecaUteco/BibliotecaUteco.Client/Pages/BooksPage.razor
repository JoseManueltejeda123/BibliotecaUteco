@page "/books"
@implements IDisposable
<PageTitle>Libros</PageTitle>

<div class="flex flex-col   w-full mt-[20px] gap-4 px-4">

   

            <div class="flex w-full items-center gap-2 justify-between">
                <h2 class="text-3xl font-semibold">Libros</h2>

                <div class="flex items-center gap-4 ">
                    <GenresDropdown>
                        <LumexTooltip ShowArrow="true" Size="Size.Small" Content=@("Géneros literarios")>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tag-icon lucide-tag"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></svg>
                        </LumexTooltip>
                    </GenresDropdown>
                    <AuthorsDropdown>
                        
                        <LumexTooltip ShowArrow="true" Size="Size.Small" Content=@("Autores")>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pen-tool-icon lucide-pen-tool"><path d="M15.707 21.293a1 1 0 0 1-1.414 0l-1.586-1.586a1 1 0 0 1 0-1.414l5.586-5.586a1 1 0 0 1 1.414 0l1.586 1.586a1 1 0 0 1 0 1.414z"/><path d="m18 13-1.375-6.874a1 1 0 0 0-.746-.776L3.235 2.028a1 1 0 0 0-1.207 1.207L5.35 15.879a1 1 0 0 0 .776.746L13 18"/><path d="m2.3 2.3 7.286 7.286"/><circle cx="11" cy="11" r="2"/></svg>

                        </LumexTooltip>
                    </AuthorsDropdown>
                  
                   
                </div>
            </div>

            <EditForm Model="Filter" OnValidSubmit="FetchGetBooksOnSearchAsync"  class="flex w-full gap-2 items-center text-black">
                <DataAnnotationsValidator/>
                <div class="w-full flex flex-col gap-1">
                    <LumexTextbox Type="@InputType.Search"
                                  Label="Buscar libro"
                                  Behavior="InputBehavior.OnInput"
                                  Clearable="true"
                                  ValueChanged="async (e) => {await HandleOnChange(context.Validate(), e); }"
                                  OnCleared="FetchGetBooksOnSearchAsync"
                                  Required="false"
                                  Disabled="@(_searchingBooks)"
                                  Value="@Filter.Filter"
                                  Placeholder="Ej. Canción de hielo y fuego"
                                  maxLenght="50"
                                  LabelPlacement="@LabelPlacement.Outside">
                       
                    </LumexTextbox>
                    
                   
                    <p class="text-[13px]">Seleciona un filtro de abajo para activar la búsqueda.</p>
                </div>
               
            </EditForm>
            <div class="mb-3">
                <LumexChip Class="cursor-pointer" Size="Size.Small" @onclick='async () => { await SetFilterBy(BookFilterType.Name); }' Variant="@(FilterBy == BookFilterType.Name ? ChipVariant.Solid : ChipVariant.Outlined)" Color="@ThemeColor.Primary">Por Nombre</LumexChip>
                <LumexChip Class="cursor-pointer" Size="Size.Small" @onclick='async () => {await SetFilterBy(BookFilterType.Author); }' Variant="@(FilterBy == BookFilterType.Author ? ChipVariant.Solid : ChipVariant.Outlined)" Color="@ThemeColor.Primary">Por Autor</LumexChip>
                <LumexChip Class="cursor-pointer" Size="Size.Small" @onclick='async () => {await SetFilterBy(BookFilterType.Genre); }' Variant="@(FilterBy == BookFilterType.Genre ? ChipVariant.Solid : ChipVariant.Outlined)" Color="@ThemeColor.Primary">Por Género</LumexChip>

            </div>
            <SidebarSectionDivider Name="Libros"/>
            <div class="grid max-sm:grid-cols-2 max-md:grid-cols-3 grid-cols-6 gap-7">
                <AuthorizeView Roles="Admin">
                    <Authorized>
                        <button @onclick="ShowCreateBookForm" class="border-dotted border-[3px] border-green-600 aspect-[2/3] w-full rounded-xl hover:bg-green-100/30 transition-all flex flex-col justify-center items-center gap-2 cursor-pointer ">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide text-green-700 lucide-book-plus-icon lucide-book-plus"><path d="M12 7v6"/><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20"/><path d="M9 10h6"/></svg>
                            <p class="text-xs text-green-700">Agregar Libro</p>
                        </button>
                    </Authorized>
                </AuthorizeView>
               
                @foreach (var book in Books)
                {
                    <BookCard OnBookDeleted="()=>{HandleOnBookDeleted(book);}" Book="@book" Index="Books.IndexOf(book)"/>
                }
                @if (_searchingBooks)
                {
                    <BookSkeleton Count="10"/>
                }

            </div>
            @if (_hasMore)
            {
                <LumexButton Variant="Variant.Light" Class="mt-4" Color="ThemeColor.Primary" >
                    Obtener Más
                </LumexButton>
            }
            else if(!_hasMore && !string.IsNullOrEmpty(_prevFilter))
            {
                <NoResultsFound />
            }

    
    
   
</div>





@functions{

    public void HandleOnBookDeleted(BookResponse book)
    {
        var bookToDelete = Books.FirstOrDefault(b => b.Id == book.Id);

        if(bookToDelete is null) return;

        Books.Remove(bookToDelete);
        StateHasChanged();
    }
    protected override async Task OnInitializedAsync(){

        await FetchGetMoreBooks();
    }
    protected override void OnInitialized()
    {
        RightBarContext.OnCreatedBookChanged += HandleBookCreated;
        RightBarContext.OnUpdatedBookChanged += HandleBookUpdated;
    }

    public void HandleBookCreated()
    {
        if (RightBarContext.CreatedBook is not null)
        {
            Books.Insert(0, RightBarContext.CreatedBook);
            StateHasChanged();
            RightBarContext.SetCreatedBook();
          
        }
    }
    
    public async Task HandleOnChange(bool contextIsValid, string? value)
    {
      
        if(!contextIsValid) return;
        Filter.Filter = value ?? "";
        
        if(cts is not null)
            await cts.CancelAsync();
        
        
        cts = new CancellationTokenSource();

        try
        {
            await Task.Delay(500, cts.Token); // Espera 1 segundo
            await FetchGetBooksOnSearchAsync();
        }
        catch
        {
            
        }
       
    }
    public void HandleBookUpdated()
    {
        if (RightBarContext.UpdatedBook is var book && book is not null)
        {
            var toReplace = Books.Find(b => b.Id == book.Id);
            
            if(toReplace is null) return;
            var index = Books.IndexOf(toReplace);
            
            if(index < 0) return;

            Books[index] = book;
            StateHasChanged();
            RightBarContext.SetBookToUpdate();
            RightBarContext.SetUpdatedBook();
          
        }
    }

    public void Dispose()
    {
        RightBarContext.OnCreatedBookChanged -= HandleBookCreated;
        RightBarContext.OnUpdatedBookChanged -= HandleBookUpdated;

    }

 

    public void ShowCreateBookForm()
    {
        RightBarContext.SetView(RightBarView.CreatingBook);
    }
    
    public async Task SetFilterBy(BookFilterType filter){
        FilterBy = filter;
        await FetchGetBooksOnSearchAsync();
    }

    public async Task FetchGetMoreBooks()
    {
        if (!_hasMore) return;

        _searchingBooks = true;
        StateHasChanged();
        var result = await BooksApiServices.GetByFilterAsync(BuildQuery(true));
        
        if (result.IsSuccessful())
        {
            Books.AddRange(result.Data);
        }

        if (!result.IsSuccessful() || result.Data.Count < 10)
        {
            _hasMore = false;
        }

        _searchingBooks = false;
        StateHasChanged();
    }

    public async Task FetchGetBooksOnSearchAsync()
    {
        Books.Clear();
        _hasMore = true;
        _searchingBooks = true;
        StateHasChanged();
        var request = BuildQuery(false);
        var result = await BooksApiServices.GetByFilterAsync(request);

        if (result.IsSuccessful())
        {
            Books = result.Data;
        }

        if (!result.IsSuccessful() || result.Data.Count < 10)
        {
            _hasMore = false;
        }

        _searchingBooks = false;
        StateHasChanged();

    }

    public GetBooksByFilterRequest BuildQuery(bool withSkip = true) => new()
    {
        BookName = FilterBy == BookFilterType.Name ? Filter.Filter : null,
        GenreName = FilterBy == BookFilterType.Genre ? Filter.Filter : null,
        AuthorName = FilterBy == BookFilterType.Author ? Filter.Filter : null,
        Take = 10,
        Skip = withSkip  ? Books.Count : 0


    };
}

@code{
    
    public bool _hasMore { get; set; } = true;
    private CancellationTokenSource? cts;
    public bool _searchingBooks { get; set; } = false;
    public FormFilter Filter { get; set; } = new();
    public string _prevFilter { get; set; } = "";
    public BookFilterType FilterBy {get; set;} = BookFilterType.Name;
    public GetBooksByFilterRequest GetBooksByFilterModel {get; set;} = new();
    public List<BookResponse> Books { get; set; } = new();
    public enum BookFilterType
    {
        Author, 
        Name,
        Genre,
        All
    }

    public class FormFilter
    {
        [MaxLength(50, ErrorMessage ="El filtro debe de tener un maxio de 50 caracteres") ]
        public string Filter { get; set; } = "";
    }
}

